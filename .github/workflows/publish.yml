name: Build and publish ICS

on:
  push:                # startet bei jedem Commit
  workflow_dispatch:   # manuell startbar im Actions-Tab
  schedule:
    - cron: "0 * * * *"   # stündlich

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # erlaubt Commit & Push mit GITHUB_TOKEN

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests beautifulsoup4 icalendar pytz
          fi

      - name: Build ICS
        env:
          RAPLA_URL: ${{ secrets.RAPLA_URL }}
        run: |
          python build.py

      - name: Show workspace (debug)
        run: |
          echo "Repo root:"
          pwd
          echo "---"
          ls -la
          echo "---"
          git status

      - name: Commit and push if changed
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Alle Änderungen inkl. neuer Dateien stagen
          git add -A

          # Wenn nichts gestaged ist -> fertig
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          # Sicherstellen, dass wir auf dem richtigen Branch sind
          git fetch origin "$BRANCH_NAME" --depth=1 || true
          git checkout "$BRANCH_NAME" || git switch -c "$BRANCH_NAME"

          # Rebase (verhindert Non-fast-forward)
          git pull --rebase origin "$BRANCH_NAME" || true

          # Commit & Push
          git commit -m "Update calendar.ics"
          git push origin HEAD:"$BRANCH_NAME"
